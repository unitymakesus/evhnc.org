function CF_Translate_Field(field_data,language){return{language:language,ID:field_data.ID,caption:field_data.caption,label:field_data.label,default:field_data.default}}function CF_Translate_Form(form,fields,language_code,save,$){var self=this;this.fields={},this.field_objs={},this.template_engine=new CF_Translate_Template_Engine($,Handlebars),this.$field_selector=$(document.getElementById("cf-translate-field-select")),this.$field_edit_area=$(document.getElementById("cf-translate-field-translator-wrap")),this.language=language_code,this.$save_button=$(document.getElementById("cf-translations-save-button")),this.update_fields={},this.init=function(){self.$save_button.attr("disabled",!1),self.$field_selector.find("option").remove(),self.setup_fields(),self.$field_selector.on("change",function(){var field=self.get_field(self.$field_selector.val());_.isUndefined(field)?alert(CFTRANS.strings.error):self.render_field_ui(field,self.language,self.$field_edit_area)}),self.$save_button.on("click",function(){if(_.isEmpty(self.update_fields))return void alert(CFTRANS.strings.nothing_to_save);var data={action:"cf_translate_save_translation",language:language_code,fields:self.update_fields,_wpnonce:save.rest_nonce,form_id:form.ID};$.post(save.api.save,data).success(function(r){cf_translation_report(CFTRANS.strings.translations_saved,!0),window.cf_translations_has_changes=!1}).error(function(r){cf_translation_report(CFTRANS.strings.save_error,!1)})})},this.setup_fields=function(){var list={};_.each(fields,function(field,id){_.has(field,"label")&&(list[id]={ID:id,label:field.label})}),self.template_engine.render_template("field_list",{fields:list},self.$field_selector),self.$field_selector.parent().parent().show().css("visibility","visible").attr("aria-hidden",!1)},this.get_field=function(id){return _.isUndefined(self.field_objs[id])&&(_.isUndefined(fields[id])?alert(settings.strings.error):self.field_objs[id]=new CF_Translate_Field(fields[id],self.language)),self.field_objs[id]},this.render_field_ui=function(field){self.$field_edit_area.empty(),self.template_engine.render_template("field",field,self.$field_edit_area),self.bind(field.ID)},this.bind=function(id){var $label=$("#cf-translate-field-label-"+id+"-"+self.language),$caption=$("#cf-translate-field-caption-"+id+"-"+self.language),$default=$("#cf-translate-field-default-"+id+"-"+self.language),handle_click=function(){_.debounce(self.add_translation(id,language_code,{label:$label.val(),caption:$caption.val(),default:$default.val()}),3e3)},handle_change=function(e){window.cf_translations_has_changes=!0,handle_click()};$label.on("change",handle_change),$caption.on("change",handle_change),$default.on("change",handle_change)},this.add_translation=function(field_id,language,translation){form.fields[language][field_id]=translation,self.update_fields[field_id]=translation,window.cf_translations_has_changes=!0}}function CF_Translate_Template_Engine($,Handlebars){var self=this;this.templates={field:$("#tpml--cf-translate-field").html(),field_list:$("#tpml--cf-translate-field-list").html()},this.get_template=function(template){return!!_.has(self.templates,template)&&self.templates[template]},this.render_template=function(template_name,data,$target){var source=self.get_template(template_name);if(0==source)return!1;var template=Handlebars.compile(source),html=template(data);$target.append(html)}}function CF_Translations(settings,$,_,Handlebars){var self=this;this.languages=[],this.language_codes={},this.$language_selector=null;var fields=[];this.init=function(){self.language_codes=cf_lang_codes,_.isEmpty(settings.form.languages)?self.add_language(settings.local):self.languages=settings.form.languages},this.add_language=function(language){return!!self.is_language_known(language)&&(self.languages[language]=self.find_language(language),!0)},this.populate_language_selector=function($selector){self.$language_selector=$selector,_.each(self.languages,function(code){self.add_language_option(code)})},this.get_language_obj=function(code){return _.isObject(self.language_codes[code])?self.language_codes[code]:void alert(settings.strings.bad_language)},this.add_language_option=function(code){var $options=$("#"+self.$language_selector.attr("id")+" option"),found=!1,lang=self.find_language(code);if($options.length){var $opt;$options.each(function(i,opt){if($opt=$(opt),_.isString($opt.val())&&$opt.val()===code)return found=!0,!1})}if(!found&&"object"==typeof lang){var lang=self.get_language_obj(code);self.$language_selector.append('<option value="'+code+'">'+lang.name+"</option>")}},this.setup_language_form=function($form,$add_language,$add_language_button){$form.on("submit",function(e){e.preventDefault(),self.load_language(self.$language_selector.val())}),$add_language_button.on("click",function(e){e.preventDefault();var lang=$add_language.val();self.is_language_known(lang)?(_.has(settings.form.fields,lang)||self.get_language_fields(lang),self.add_language(lang),self.add_language_option(lang),self.$language_selector.val(lang)):cf_translation_report(settings.strings.bad_language,!1)})},this.get_language_fields=function(language){$.get(settings.data.api.lang,{action:"cf_translate_get_language",form_id:settings.form.ID,language:language,_wpnonce:settings.data.rest_nonce}).success(function(r){settings.form.fields[language]=language,fields[language]=r}).error(function(r){_.has(r,"message")?alert(r.message):alert(settings.string.error)})},this.find_language=function(language){if(self.is_language_known(language))return self.language_codes[language]},this.is_language_known=function(language){return _.has(self.language_codes,language)},this.find_language_by_name=function(language){if(self.is_language_known(language))return self.find_language(language)},this.load_language=function(language_code){var lfields;_.has(fields,language_code)?lfields=fields[language_code]:_.has(settings.form.fields,language_code)&&!_.isEmpty(settings.form.fields[language_code])&&(lfields=settings.form.fields[language_code]);var translator=new CF_Translate_Form(settings.form,lfields,language_code,settings.data,$);translator.init()}}function cf_translation_report(message,good){var $not_saved=(jQuery(document.getElementById("cf-translate-header")),jQuery(document.getElementById("cf-translations-not-saved"))),$saved=jQuery(document.getElementById("cf-translations-saved"));good?($not_saved.html("").hide().css("visibility","hidden").attr("aria-hidden",!0),$saved.html(message).show().css("visibility","visible").attr("aria-hidden",!1)):($not_saved.html(message).show().css("visibility","visible").attr("aria-hidden",!1),$saved.html("").hide().css("visibility","hidden").attr("aria-hidden",!0))}jQuery(document).ready(function($){if(window.cf_translations_has_changes=!1,_.isObject(CFTRANS)){var cf_translations=new CF_Translations(CFTRANS,$,_,Handlebars);cf_translations.init();var $form=$(document.getElementById("cf-translate-language-control")),$language_selector=$(document.getElementById("cf-translate-language-chooser")),$add_language=$(document.getElementById("cf-translate-add-language"));$add_language.select2();var $add_language_button=$(document.getElementById("cf-translate-add-language-button"));cf_translations.populate_language_selector($language_selector),cf_translations.setup_language_form($form,$add_language,$add_language_button)}window.onbeforeunload=function(e){if(1==window.cf_translations_has_changes){var message=CFTRANS.unsaved_translations;return e=e||window.event,e&&(e.returnValue=message),message}}});